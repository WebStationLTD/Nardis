import "@/styles/globals.css";
import StoreNavigation from "@/components/storeNavigation";
import FooterSection from "@/components/footer";

import { Roboto } from "next/font/google";
// import { getCategories } from "@/services/productService";

const roboto = Roboto({
  subsets: ["cyrillic"],
  variable: "--font-roboto",
  display: "swap",
});

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default async function RootLayout({ children }) {
  const res = await fetch(
    "https://nardis.rosset.website/wp-json/wc/v3/products/categories?per_page=100",
    {
      headers: {
        Authorization:
          "Basic " +
          Buffer.from(
            `${process.env.WC_CONSUMER_KEY}:${process.env.WC_CONSUMER_SECRET}`
          ).toString("base64"),
      },
      next: { revalidate: 60 },
    }
  );

  const allCategories = await res.json();

  // Масив с желаните категории в мега менюто
  const megaMenuCategoryIds = [17, 26]; // ID за Artdeco ASIAN SPA и Грим

  // Рекурсивно строим дървовидна структура
  function buildCategoryTree(categories, parentId = 0) {
    return categories
      .filter((cat) => cat.parent === parentId)
      .map((cat) => ({
        ...cat,
        subcategories: buildCategoryTree(categories, cat.id),
      }));
  }

  // Взима всички подкатегории рекурсивно (flatten)
  function flattenSubcategories(category) {
    const result = [];

    function traverse(cat) {
      if (cat.subcategories && cat.subcategories.length > 0) {
        cat.subcategories.forEach((subcat) => {
          result.push(subcat);
          traverse(subcat);
        });
      }
    }

    traverse(category);
    return result;
  }

  const categoryTree = buildCategoryTree(allCategories);

  // Вземаме само избраните top-level категории + всичките им подкатегории (flatten)
  const categoriesWithChildren = categoryTree
    .filter((cat) => megaMenuCategoryIds.includes(cat.id))
    .map((cat) => ({
      ...cat,
      subcategories: flattenSubcategories(cat),
    }));

  // Групиране на категории по parent-child
  // const parentCategories = allCategories.filter((cat) => cat.parent === 0);

  return (
    <html lang="en">
      <body className={roboto.className}>
        <StoreNavigation categories={categoriesWithChildren} />

        {children}
        <FooterSection />
      </body>
    </html>
  );
}
